---
  name: Deployment
  on:
    workflow_dispatch:
      inputs:
        env:
          description: "Deploy to (dev|prod|dev prod)"
          required: true
          type: string
          default: "dev"
        clean:
          description: "Clean cache"
          required: true
          type: boolean
          default: false
        cleanDiskSpace:
          description: "Cleans up unncessary tools"
          required: true
          type: boolean
          default: true
        excludeSubfolder:
          description: "Exclude a subfolder from deletion"
          required: false
          type: string
          default: ""
        index-mode:
          description: 'Type of indexing. "index" to push to Algolia, "console" for dry run.'
          required: true
          default: "index"
          type: choice
          options:
            - console
            - index
  jobs:
    deployment:
      name: Deployment
      uses: AdobeDocs/adp-devsite-workflow/.github/workflows/gatsby-deploy.yml@main
      secrets: inherit
      with:
        env: ${{ inputs.env }}
        clean: ${{ inputs.clean }}
        clean-disk-space: ${{ inputs.cleanDiskSpace }}
        excludeSubfolder: ${{ inputs.excludeSubfolder }}
        index-mode: ${{ inputs.index-mode }}
        NODE_OPTIONS: "--max_old_space_size=7000"
        IMS_BASE_URL_STAGE: "https://ims-na1-stg1.adobelogin.com"
        FFC_BASE_URL_STAGE: "https://ffc-addon-stage.adobe.io/"
        GATSBY_EXPRESS_URL_STAGE: "https://stage.projectx.corp.adobe.com/new"
        IMS_BASE_URL_PROD: "https://ims-na1.adobelogin.com"
        FFC_BASE_URL_PROD: "https://ffc-addon.adobe.io/"
        GATSBY_EXPRESS_URL_PROD: "https://express.adobe.com/new"
    
    upload-playground-samples:
      name: Upload Playground Samples
      needs: deployment
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Node v20 for Yarn v3
          uses: actions/setup-node@v3
          with:
            node-version: "20.19.5" # Current LTS version

        - name: Enable Corepack for Yarn v3
          run: corepack enable

        - name: Install Dependencies
          run: yarn install
        
        - name: Upload playground samples
          run: node upload-playground-samples.mjs
          env:
            IMS_BASE_URL: ${{ inputs.env == 'prod' && 'https://ims-na1.adobelogin.com' || 'https://ims-na1-stg1.adobelogin.com' }}
            FFC_BASE_URL: ${{ inputs.env == 'prod' && 'https://ffc-addon.adobe.io/' || 'https://ffc-addon-stage.adobe.io/' }}
            PLAYGROUND_CLIENT_ID: ${{ inputs.env == 'prod' && secrets.PLAYGROUND_CLIENT_ID || secrets.PLAYGROUND_CLIENT_ID_STAGE }}
            PLAYGROUND_CLIENT_SECRET: ${{ inputs.env == 'prod' && secrets.PLAYGROUND_CLIENT_SECRET || secrets.PLAYGROUND_CLIENT_SECRET_STAGE }}
            PLAYGROUND_AUTH_CODE: ${{ inputs.env == 'prod' && secrets.PLAYGROUND_AUTH_CODE || secrets.PLAYGROUND_AUTH_CODE_STAGE }}
            PLAYGROUND_API_KEY: ${{ secrets.PLAYGROUND_API_KEY }}